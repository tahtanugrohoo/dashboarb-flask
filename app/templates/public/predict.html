{% extends "base.html" %}
{% block title %}Kuesioner Prediksi{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-9">
    <div class="card shadow-sm border-0">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex align-items-start justify-content-between gap-3">
          <div>
            <h1 class="h4 mb-1">Kuesioner Pola Pemanfaatan AI Generatif</h1>
            <div class="text-muted">Isi singkat, responsif untuk HP / tablet / PC.</div>
          </div>
          <span class="badge text-bg-primary-subtle text-primary border align-self-start">Anonim</span>
        </div>

        <hr class="my-3">

        <!-- progress -->
        <div class="mb-3">
          <div class="d-flex justify-content-between small text-muted mb-1">
            <span>Progress</span>
            <span id="progressText">0%</span>
          </div>
          <div class="progress" role="progressbar" aria-label="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
          </div>
        </div>

        <form method="post" id="qForm" novalidate>
          {{ form.hidden_tag() }}

          <!-- Persetujuan -->
          <div class="mb-3">
            <div class="form-check">
              {{ form.consent(class_="form-check-input", id="consent") }}
              <label class="form-check-label" for="consent">{{ form.consent.label.text }}</label>
            </div>
            {% for e in form.consent.errors %}
              <div class="text-danger small mt-1">{{ e }}</div>
            {% endfor %}
          </div>

          <div class="accordion" id="accordionQ">

            <!-- Profil -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="hProfile">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cProfile" aria-expanded="true" aria-controls="cProfile">
                  Profil Responden
                </button>
              </h2>
              <div id="cProfile" class="accordion-collapse collapse show" aria-labelledby="hProfile" data-bs-parent="#accordionQ">
                <div class="accordion-body">
                  <div class="row g-3">
                    <div class="col-12">
                      <label class="form-label">{{ form.name_optional.label.text }}</label>
                      {{ form.name_optional(class_="form-control", placeholder="Boleh dikosongkan") }}
                      {% for e in form.name_optional.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label">{{ form.university.label.text }} <span class="text-danger">*</span></label>
                      {{ form.university(class_="form-control", placeholder="Contoh: UNSOED") }}
                      {% for e in form.university.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label">{{ form.major.label.text }} <span class="text-danger">*</span></label>
                      {{ form.major(class_="form-control", placeholder="Contoh: Teknik Informatika") }}
                      {% for e in form.major.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    </div>
                    <div class="col-12">
                      <label class="form-label">{{ form.semester.label.text }} <span class="text-danger">*</span></label>
                      <div class="d-flex flex-wrap gap-2">
                        {% for sub in form.semester %}
                          <div class="form-check form-check-inline">
                            {{ sub(class_="form-check-input") }}
                            <label class="form-check-label">{{ sub.label.text }}</label>
                          </div>
                        {% endfor %}
                      </div>
                      {% for e in form.semester.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    </div>
                    <div class="col-12">
                      <label class="form-label">{{ form.used_ai.label.text }} <span class="text-danger">*</span></label>
                      <div class="d-flex flex-wrap gap-3">
                        {% for sub in form.used_ai %}
                          <div class="form-check form-check-inline">
                            {{ sub(class_="form-check-input") }}
                            <label class="form-check-label">{{ sub.label.text }}</label>
                          </div>
                        {% endfor %}
                      </div>
                      {% for e in form.used_ai.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pola umum -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="hGeneral">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cGeneral" aria-expanded="false" aria-controls="cGeneral">
                  Pola Umum Pemanfaatan
                </button>
              </h2>
              <div id="cGeneral" class="accordion-collapse collapse" aria-labelledby="hGeneral" data-bs-parent="#accordionQ">
                <div class="accordion-body">

                  <div class="mb-3">
                    <label class="form-label">{{ form.when_multi.label.text }} <span class="text-danger">*</span></label>
                    <div class="row g-2">
                      {% for sub in form.when_multi %}
                        <div class="col-12 col-md-6">
                          <div class="form-check">
                            {{ sub(class_="form-check-input") }}
                            <label class="form-check-label">{{ sub.label.text }}</label>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="mt-2">
                      {{ form.when_other_text(class_="form-control", placeholder="Isi jika memilih 'Lainnya'") }}
                    </div>
                    {% for e in form.when_multi.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    {% for e in form.when_other_text.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>

                  <div class="mb-3">
                    <label class="form-label">{{ form.when_single.label.text }} <span class="text-danger">*</span></label>
                    <div class="row g-2">
                      {% for sub in form.when_single %}
                        <div class="col-12 col-md-6">
                          <div class="form-check">
                            {{ sub(class_="form-check-input") }}
                            <label class="form-check-label">{{ sub.label.text }}</label>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="mt-2">
                      {{ form.when_single_other_text(class_="form-control", placeholder="Isi jika memilih 'Lainnya'") }}
                    </div>
                    {% for e in form.when_single.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    {% for e in form.when_single_other_text.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>

                  <hr>

                  <div class="mb-3">
                    <label class="form-label">{{ form.use_multi.label.text }} <span class="text-danger">*</span></label>
                    <div class="row g-2">
                      {% for sub in form.use_multi %}
                        <div class="col-12 col-md-6">
                          <div class="form-check">
                            {{ sub(class_="form-check-input") }}
                            <label class="form-check-label">{{ sub.label.text }}</label>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="mt-2">
                      {{ form.use_other_text(class_="form-control", placeholder="Isi jika memilih 'Lainnya'") }}
                    </div>
                    {% for e in form.use_multi.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    {% for e in form.use_other_text.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>

                  <div class="mb-3">
                    <label class="form-label">{{ form.use_single.label.text }} <span class="text-danger">*</span></label>
                    <div class="row g-2">
                      {% for sub in form.use_single %}
                        <div class="col-12 col-md-6">
                          <div class="form-check">
                            {{ sub(class_="form-check-input") }}
                            <label class="form-check-label">{{ sub.label.text }}</label>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="mt-2">
                      {{ form.use_single_other_text(class_="form-control", placeholder="Isi jika memilih 'Lainnya'") }}
                    </div>
                    {% for e in form.use_single.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                    {% for e in form.use_single_other_text.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>

                  <div class="mb-3">
                    <label class="form-label">{{ form.portion.label.text }} <span class="text-danger">*</span></label>
                    <div class="vstack gap-2">
                      {% for sub in form.portion %}
                        <div class="form-check">
                          {{ sub(class_="form-check-input") }}
                          <label class="form-check-label">{{ sub.label.text }}</label>
                        </div>
                      {% endfor %}
                    </div>
                    {% for e in form.portion.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>

                  <div class="mb-0">
                    <label class="form-label">{{ form.freq.label.text }} <span class="text-danger">*</span></label>
                    <div class="vstack gap-2">
                      {% for sub in form.freq %}
                        <div class="form-check">
                          {{ sub(class_="form-check-input") }}
                          <label class="form-check-label">{{ sub.label.text }}</label>
                        </div>
                      {% endfor %}
                    </div>
                    {% for e in form.freq.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>

                </div>
              </div>
            </div>

            <!-- Skala -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="hLikert">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cLikert" aria-expanded="false" aria-controls="cLikert">
                  Pernyataan (Skala 1–5)
                </button>
              </h2>
              <div id="cLikert" class="accordion-collapse collapse" aria-labelledby="hLikert" data-bs-parent="#accordionQ">
                <div class="accordion-body">
                  <div class="alert alert-info py-2 small mb-3">
                    1 = Sangat Tidak Setuju • 2 = Tidak Setuju • 3 = Netral • 4 = Setuju • 5 = Sangat Setuju
                  </div>

                  {% macro likertCard(title, fields) -%}
                    <div class="card border-0 shadow-sm mb-3">
                      <div class="card-body">
                        <div class="fw-semibold mb-2">{{ title }}</div>
                        {% for f in fields %}
                          <div class="mb-3">
                            <div class="small fw-semibold mb-2">{{ f.label.text }}</div>
                            <div class="btn-group flex-wrap" role="group" aria-label="likert">
                              {% for sub in f %}
                                {{ sub(class_="btn-check") }}
                                <label class="btn btn-outline-secondary btn-sm">{{ sub.label.text }}</label>
                              {% endfor %}
                            </div>
                            {% for e in f.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {%- endmacro %}

                  {{ likertCard("Tujuan & Perencanaan", [form.p1, form.p2, form.p3, form.p4]) }}
                  {{ likertCard("Iterasi & Modifikasi", [form.i1, form.i2, form.i3, form.i4]) }}
                  {{ likertCard("Verifikasi & Evaluasi", [form.v1, form.v2, form.v3, form.v4]) }}
                  {{ likertCard("Orientasi Pemahaman", [form.u1, form.u2, form.u3, form.u4]) }}
                  {{ likertCard("Etika & Kemandirian", [form.e1, form.e2, form.e3, form.e4]) }}

                  <div class="card border-0 shadow-sm">
                    <div class="card-body">
                      <div class="fw-semibold mb-2">Situasi Penggunaan (Opsional)</div>
                      {% for f in [form.s1, form.s2, form.s3] %}
                        <div class="mb-3">
                          <div class="small fw-semibold mb-2">{{ f.label.text }}</div>
                          <div class="btn-group flex-wrap" role="group" aria-label="likert optional">
                            {% for sub in f %}
                              {{ sub(class_="btn-check") }}
                              <label class="btn btn-outline-secondary btn-sm">{{ sub.label.text }}</label>
                            {% endfor %}
                          </div>
                          {% for e in f.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                        </div>
                      {% endfor %}
                    </div>
                  </div>

                </div>
              </div>
            </div>

          </div>

          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary" type="submit">{{ form.submit.label.text }}</button>
            <button class="btn btn-outline-secondary" type="reset">Reset</button>
          </div>

          <div class="text-muted small mt-2">
            Kolom bertanda <span class="text-danger">*</span> wajib diisi.
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Progress sederhana: hitung field yang sudah terisi (perkiraan, cukup untuk UI)
  (function() {
    const form = document.getElementById("qForm");
    const bar = document.getElementById("progressBar");
    const text = document.getElementById("progressText");
    if (!form || !bar || !text) return;

    const requiredSelectors = [
      // consent
      "#consent",
      // text required
      "input[name='university']",
      "input[name='major']",
      // radios required (semester, used_ai, when_single, use_single, portion, freq, and all likert required)
      "input[name='semester']",
      "input[name='used_ai']",
      "input[name='when_single']",
      "input[name='use_single']",
      "input[name='portion']",
      "input[name='freq']",
      "input[name='p1']", "input[name='p2']", "input[name='p3']", "input[name='p4']",
      "input[name='i1']", "input[name='i2']", "input[name='i3']", "input[name='i4']",
      "input[name='v1']", "input[name='v2']", "input[name='v3']", "input[name='v4']",
      "input[name='u1']", "input[name='u2']", "input[name='u3']", "input[name='u4']",
      "input[name='e1']", "input[name='e2']", "input[name='e3']", "input[name='e4']",
    ];

    // checkbox groups required: when_multi, use_multi
    const checkboxGroups = ["when_multi", "use_multi"];

    function isCheckedAny(name) {
      return !!form.querySelector(`input[name='${name}']:checked`);
    }

    function isFilled(sel) {
      const el = form.querySelector(sel);
      if (!el) {
        // radio group selector: if selector matches multiple inputs, check any checked
        const radios = form.querySelectorAll(sel);
        if (radios && radios.length) {
          for (const r of radios) if (r.checked) return true;
          return false;
        }
        return false;
      }
      if (el.type === "checkbox") return el.checked;
      if (el.type === "radio") return !!form.querySelector(sel + ":checked");
      return (el.value || "").trim().length > 0;
    }

    function calc() {
      let total = 0;
      let done = 0;

      // required selectors
      for (const s of requiredSelectors) {
        total += 1;
        if (isFilled(s)) done += 1;
      }

      // checkbox groups
      for (const g of checkboxGroups) {
        total += 1;
        if (isCheckedAny(g)) done += 1;
      }

      const pct = Math.round((done / total) * 100);
      bar.style.width = pct + "%";
      text.textContent = pct + "%";
    }

    form.addEventListener("change", calc);
    form.addEventListener("input", calc);
    calc();
  })();
</script>
{% endblock %}
