{% extends "base.html" %}
{% block title %}Kuesioner{% endblock %}
{% block content %}
<div class="q-wrap">
  <div class="q-head">
    <div>
      <h1 class="q-title">Kuesioner Pola Pemanfaatan AI Generatif</h1>
      <p class="q-sub">Pengisian bersifat anonim. Mohon isi sesuai kondisi Anda.</p>
    </div>
    <div class="q-progress" aria-label="Progress pengisian">
      <div class="q-progress__bar" id="progressBar"></div>
      <div class="q-progress__text" id="progressText">0%</div>
    </div>
  </div>

  <form method="post" id="questionnaireForm" class="q-form">
    {{ form.hidden_tag() }}

    <!-- Card: Consent -->
    <section class="card">
      <h2 class="card-title">Persetujuan</h2>
      <label class="checkline">
        {{ form.consent(class_="checkline__box", id="consent") }}
        <span>{{ form.consent.label.text }}</span>
      </label>
      {% for e in form.consent.errors %}<div class="err">{{ e }}</div>{% endfor %}
    </section>

    <!-- Card: Profil -->
    <section class="card">
      <h2 class="card-title">Profil Responden</h2>

      <div class="grid-2">
        <div class="field">
          <label class="lbl">{{ form.a1_name.label.text }}</label>
          {{ form.a1_name(class_="inp", placeholder="Opsional") }}
          {% for e in form.a1_name.errors %}<div class="err">{{ e }}</div>{% endfor %}
        </div>

        <div class="field">
          <label class="lbl">{{ form.a2_univ.label.text }}</label>
          {{ form.a2_univ(class_="inp", placeholder="Contoh: UNSOED") }}
          {% for e in form.a2_univ.errors %}<div class="err">{{ e }}</div>{% endfor %}
        </div>

        <div class="field">
          <label class="lbl">{{ form.a3_major.label.text }}</label>
          {{ form.a3_major(class_="inp", placeholder="Contoh: Teknik Informatika") }}
          {% for e in form.a3_major.errors %}<div class="err">{{ e }}</div>{% endfor %}
        </div>

        <div class="field">
          <label class="lbl">{{ form.a4_semester.label.text }}</label>
          <div class="chips">
            {% for sub in form.a4_semester %}
              <label class="chip">
                {{ sub(class_="chip__radio") }}
                <span class="chip__text">{{ sub.label.text }}</span>
              </label>
            {% endfor %}
          </div>
          {% for e in form.a4_semester.errors %}<div class="err">{{ e }}</div>{% endfor %}
        </div>
      </div>

      <div class="field">
        <label class="lbl">{{ form.a5_used_ai.label.text }}</label>
        <div class="chips">
          {% for sub in form.a5_used_ai %}
            <label class="chip">
              {{ sub(class_="chip__radio") }}
              <span class="chip__text">{{ sub.label.text }}</span>
            </label>
          {% endfor %}
        </div>
        {% for e in form.a5_used_ai.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>
    </section>

    <!-- Card: Pola Umum -->
    <section class="card">
      <h2 class="card-title">Pola Umum Pemanfaatan</h2>

      <div class="field">
        <label class="lbl">{{ form.b1a_when_multi.label.text }}</label>
        <div class="checks">
          {% for sub in form.b1a_when_multi %}
            <label class="check">
              {{ sub(class_="check__box") }}
              <span class="check__text">{{ sub.label.text }}</span>
            </label>
          {% endfor %}
        </div>
        {{ form.b1a_other_text(class_="inp", placeholder="Isi jika memilih Lainnya") }}
        {% for e in form.b1a_when_multi.errors %}<div class="err">{{ e }}</div>{% endfor %}
        {% for e in form.b1a_other_text.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div class="field">
        <label class="lbl">{{ form.b1b_when_single.label.text }}</label>
        <div class="radios">
          {% for sub in form.b1b_when_single %}
            <label class="radio">
              {{ sub(class_="radio__box") }}
              <span class="radio__text">{{ sub.label.text }}</span>
            </label>
          {% endfor %}
        </div>
        {{ form.b1b_other_text(class_="inp", placeholder="Isi jika memilih Lainnya") }}
        {% for e in form.b1b_when_single.errors %}<div class="err">{{ e }}</div>{% endfor %}
        {% for e in form.b1b_other_text.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div class="field">
        <label class="lbl">{{ form.b2a_what_multi.label.text }}</label>
        <div class="checks">
          {% for sub in form.b2a_what_multi %}
            <label class="check">
              {{ sub(class_="check__box") }}
              <span class="check__text">{{ sub.label.text }}</span>
            </label>
          {% endfor %}
        </div>
        {{ form.b2a_other_text(class_="inp", placeholder="Isi jika memilih Lainnya") }}
        {% for e in form.b2a_what_multi.errors %}<div class="err">{{ e }}</div>{% endfor %}
        {% for e in form.b2a_other_text.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div class="field">
        <label class="lbl">{{ form.b2b_what_single.label.text }}</label>
        <div class="radios">
          {% for sub in form.b2b_what_single %}
            <label class="radio">
              {{ sub(class_="radio__box") }}
              <span class="radio__text">{{ sub.label.text }}</span>
            </label>
          {% endfor %}
        </div>
        {{ form.b2b_other_text(class_="inp", placeholder="Isi jika memilih Lainnya") }}
        {% for e in form.b2b_what_single.errors %}<div class="err">{{ e }}</div>{% endfor %}
        {% for e in form.b2b_other_text.errors %}<div class="err">{{ e }}</div>{% endfor %}
      </div>

      <div class="grid-2">
        <div class="field">
          <label class="lbl">{{ form.b3_portion.label.text }}</label>
          <div class="radios">
            {% for sub in form.b3_portion %}
              <label class="radio">
                {{ sub(class_="radio__box") }}
                <span class="radio__text">{{ sub.label.text }}</span>
              </label>
            {% endfor %}
          </div>
          {% for e in form.b3_portion.errors %}<div class="err">{{ e }}</div>{% endfor %}
        </div>

        <div class="field">
          <label class="lbl">{{ form.b4_freq.label.text }}</label>
          <div class="radios">
            {% for sub in form.b4_freq %}
              <label class="radio">
                {{ sub(class_="radio__box") }}
                <span class="radio__text">{{ sub.label.text }}</span>
              </label>
            {% endfor %}
          </div>
          {% for e in form.b4_freq.errors %}<div class="err">{{ e }}</div>{% endfor %}
        </div>
      </div>
    </section>

    <!-- Likert helper -->
    {% macro likert_block(title, fields, optional=False) -%}
      <section class="card">
        <div class="card-title-row">
          <h2 class="card-title">{{ title }}</h2>
          {% if optional %}<span class="badge">Opsional</span>{% endif %}
        </div>
        <div class="likert-hint">
          <span>1 = Sangat Tidak Setuju</span>
          <span>5 = Sangat Setuju</span>
        </div>

        <div class="likert-list">
          {% for f in fields %}
            <div class="likert-item">
              <div class="likert-q">{{ f.label.text }}</div>
              <div class="likert-choices">
                {% for sub in f %}
                  <label class="likert-chip">
                    {{ sub(class_="likert-radio") }}
                    <span class="likert-chip__t">{{ sub.label.text }}</span>
                  </label>
                {% endfor %}
              </div>
              {% for e in f.errors %}<div class="err">{{ e }}</div>{% endfor %}
            </div>
          {% endfor %}
        </div>
      </section>
    {%- endmacro %}

    {{ likert_block("Tujuan & Perencanaan", [form.c11, form.c12, form.c13, form.c14]) }}
    {{ likert_block("Iterasi & Modifikasi", [form.c21, form.c22, form.c23, form.c24]) }}
    {{ likert_block("Verifikasi & Evaluasi", [form.c31, form.c32, form.c33, form.c34]) }}
    {{ likert_block("Orientasi Pemahaman", [form.c41, form.c42, form.c43, form.c44]) }}
    {{ likert_block("Etika & Kemandirian", [form.c51, form.c52, form.c53, form.c54]) }}
    {{ likert_block("Situasi Penggunaan", [form.d1, form.d2, form.d3], optional=True) }}

    <div class="sticky-actions">
      <button class="btn-primary" type="submit">{{ form.submit.label.text }}</button>
      <div class="mini-note">Pastikan semua bagian wajib sudah terisi.</div>
    </div>
  </form>
</div>

<script>
  (function () {
    const form = document.getElementById('questionnaireForm');
    const bar = document.getElementById('progressBar');
    const text = document.getElementById('progressText');

    // hitung "terisi" secara sederhana: required checkbox/radio/text yang punya nilai
    function calcProgress() {
      // Required fields: semua yang punya atribut required dari WTForms tidak otomatis,
      // jadi kita estimasi dari input yang ada + daftar name yang wajib.
      const requiredNames = [
        'consent',
        'a2_univ','a3_major','a4_semester','a5_used_ai',
        'b1a_when_multi','b1b_when_single','b2a_what_multi','b2b_what_single',
        'b3_portion','b4_freq',
        'c11','c12','c13','c14',
        'c21','c22','c23','c24',
        'c31','c32','c33','c34',
        'c41','c42','c43','c44',
        'c51','c52','c53','c54'
      ];

      let filled = 0;

      const hasChecked = (name) => !!form.querySelector(`input[name="${name}"]:checked`);
      const hasAnyChecked = (name) => form.querySelectorAll(`input[name="${name}"]:checked`).length > 0;
      const hasText = (name) => {
        const el = form.querySelector(`[name="${name}"]`);
        return el && (el.value || '').trim().length > 0;
      };

      for (const n of requiredNames) {
        if (n === 'consent') { if (hasChecked(n)) filled++; continue; }
        if (['a4_semester','a5_used_ai','b1b_when_single','b2b_what_single','b3_portion','b4_freq',
             'c11','c12','c13','c14','c21','c22','c23','c24','c31','c32','c33','c34',
             'c41','c42','c43','c44','c51','c52','c53','c54'].includes(n)) {
          if (hasChecked(n)) filled++;
          continue;
        }
        if (['b1a_when_multi','b2a_what_multi'].includes(n)) {
          if (hasAnyChecked(n)) filled++;
          continue;
        }
        if (['a2_univ','a3_major'].includes(n)) {
          if (hasText(n)) filled++;
          continue;
        }
      }

      const pct = Math.round((filled / requiredNames.length) * 100);
      bar.style.width = pct + '%';
      text.textContent = pct + '%';
    }

    form.addEventListener('change', calcProgress);
    form.addEventListener('input', calcProgress);
    calcProgress();
  })();
</script>
{% endblock %}
